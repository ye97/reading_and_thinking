
# 矩阵求导术（下） - 知乎

本文承接上篇 [https://zhuanlan.zhihu.com/p/24709748](https://zhuanlan.zhihu.com/p/24709748)，来讲矩阵对矩阵的求导术。使用小写字母x表示标量，粗体小写字母![[公式]](assets/1620480789-157db37c30c20148200a7c1b21426ea7.svg)表示列向量，大写字母X表示矩阵。矩阵对矩阵的求导采用了向量化的思路，常应用于二阶方法中Hessian矩阵的分析。

首先来琢磨一下定义。矩阵对矩阵的导数，需要什么样的定义？第一，矩阵F(p×q)对矩阵X(m×n)的导数应包含所有mnpq个偏导数![[公式]](assets/1620480789-7f9ad7277be41fffbd9c0a5dd2b9e99f.svg)，从而不损失信息；第二，导数与微分有简明的联系，因为在计算导数和应用中需要这个联系；第三，导数有简明的从整体出发的算法。我们先定义向量![[公式]](assets/1620480789-177bd768a42daa1895a59b76f3078ec1.svg)(p×1)对向量![[公式]](assets/1620480789-878735fee9916dce1437274caeb8a5c1.svg)(m×1)的导数![[公式]](assets/1620480789-9406b5eb253100699ad8bac492b9fb24.svg)(m×p)，有![[公式]](assets/1620480789-3608fd616421368ebb3550e4675b7533.svg)；再定义矩阵的（按列优先）向量化![[公式]](assets/1620480789-451bb3f31a70ffb086af84cbfd002aa8.svg)(mn×1)，并定义矩阵F对矩阵X的导数![[公式]](assets/1620480789-87745b893e86541e1e6e529ba549bf65.svg)(mn×pq)。导数与微分有联系![[公式]](assets/1620480789-96628d9b8b54f96e8ecfa9ae8e0ee473.svg)。几点说明如下：

1.  按此定义，标量f对矩阵X(m×n)的导数![[公式]](assets/1620480789-fe6ea7be6eb9c415d7b6b66beb5f00ef.svg)是mn×1向量，与上篇的定义不兼容，不过二者容易相互转换。为避免混淆，用记号![[公式]](assets/1620480789-6b9f239705ee7da1a6ce8799041cfd02.svg)表示上篇定义的m×n矩阵，则有![[公式]](assets/1620480789-d134ad830da13bed8f5983d0ece77732.svg)。虽然本篇的技术可以用于标量对矩阵求导这种特殊情况，但使用上篇中的技术更方便。读者可以通过上篇中的算例试验两种方法的等价转换。  
    
2.  标量对矩阵的二阶导数，又称Hessian矩阵，定义为![[公式]](assets/1620480789-04d0f4b2a969214ecade2f2bed687431.svg)(mn×mn)，是对称矩阵。对向量![[公式]](assets/1620480789-fe6ea7be6eb9c415d7b6b66beb5f00ef.svg)或矩阵![[公式]](assets/1620480789-6b9f239705ee7da1a6ce8799041cfd02.svg)求导都可以得到Hessian矩阵，但从矩阵![[公式]](assets/1620480789-6b9f239705ee7da1a6ce8799041cfd02.svg)出发更方便。
3.  ![[公式]](assets/1620480789-cb6df17b8552ee0e799bb9268b42cc5a.svg)，求导时矩阵被向量化，弊端是这在一定程度破坏了矩阵的结构，会导致结果变得形式复杂；好处是多元微积分中关于梯度、Hessian矩阵的结论可以沿用过来，只需将矩阵向量化。例如优化问题中，牛顿法的更新![[公式]](assets/1620480789-07009f2262a4a901c33e696b7e65fd0e.svg)，满足**![[公式]](assets/1620480789-ba7b960658b91b891a072da5694ec698.svg)。**
4.  在资料中，矩阵对矩阵的导数还有其它定义，比如![[公式]](assets/1620480789-ad52c9cbd5a9150c907c6b966fa9bfd6.svg)(mp×nq)，或是![[公式]](assets/1620480789-98669c258fe7395b01fbdd28967ed586.svg)(mp×nq)，它能兼容上篇中的标量对矩阵导数的定义，但微分与导数的联系（dF等于![[公式]](assets/1620480789-9ef0d27880fa6426eef7cd30602db55a.svg)中逐个m×n子块分别与dX做内积）不够简明，不便于计算和应用。资料\[5\]综述了以上定义，并批判它们是坏的定义，能配合微分运算的才是好的定义。
5.  在资料中，有分子布局和分母布局两种定义，其中向量对向量的导数的排布有所不同。本文使用的是分母布局，机器学习和优化中的梯度矩阵采用此定义。而控制论等领域中的Jacobian矩阵采用分子布局，向量![[公式]](assets/1620480789-177bd768a42daa1895a59b76f3078ec1.svg)对向量![[公式]](assets/1620480789-878735fee9916dce1437274caeb8a5c1.svg)的导数定义是![[公式]](assets/1620480789-bd426f5dffeaa68f417349297facc432.svg)，对应地导数与微分的联系是![[公式]](assets/1620480789-bbede6a70dda37047edcbf982cca4f70.svg)；同样通过向量化定义矩阵F对矩阵X的导数![[公式]](assets/1620480789-87745b893e86541e1e6e529ba549bf65.svg)，有![[公式]](assets/1620480789-1d70cfe35e384c74193b0a9c32653679.svg)。两种布局下的导数互为转置，二者求微分的步骤是相同的，仅在对照导数与微分的联系时有一个转置的区别，读者可根据所在领域的习惯选定一种布局。

  

然后来建立运算法则。仍然要利用导数与微分的联系![[公式]](assets/1620480789-96628d9b8b54f96e8ecfa9ae8e0ee473.svg)，求微分的方法与上篇相同，而从微分得到导数需要一些向量化的技巧：

1.  线性：![[公式]](assets/1620480789-e3d45831bc39c381a4df04c3708e4091.svg)。
2.  矩阵乘法：![[公式]](assets/1620480789-b39dabe61d9fc583bff8439eaa9ea2f4.svg)，其中![[公式]](assets/1620480789-a52041d17b3fad23be63e7350ad2bfa7.svg)表示Kronecker积，A(m×n)与B(p×q)的Kronecker积是![[公式]](assets/1620480789-d93ca5d520f0f9da4469bd9d8a67f974.svg)(mp×nq)。此式证明见张贤达《矩阵分析与应用》第107-108页。
3.  转置：![[公式]](assets/1620480789-ea58df8e913eceff3cfd39fe02091e8e.svg)，A是m×n矩阵，其中![[公式]](assets/1620480789-7e544b7256fcfdc46a77a2974c5611be.svg)(mn×mn)是交换矩阵(commutation matrix)，将按列优先的向量化变为按行优先的向量化。例如![[公式]](assets/1620480789-e1cb6b6db24d593bc3b1a522bca2141f.svg)。
4.  逐元素乘法：![[公式]](assets/1620480789-6bf20bba09a25d4dc9bfc5f7fe33337b.svg)，其中![[公式]](assets/1620480789-dcdf3f1818f72e7821f4afefe08e14ff.svg)(mn×mn)是用A的元素（按列优先）排成的对角阵。

  

观察一下可以断言，**若矩阵函数F是矩阵X经加减乘法、逆、行列式、逐元素函数等运算构成，则使用相应的运算法则对F求微分，再做向量化并使用技巧将其它项交换至vec(dX)左侧，对照导数与微分的联系![[公式]](assets/1620480789-96628d9b8b54f96e8ecfa9ae8e0ee473.svg)，即能得到导数。**

**特别地，若矩阵退化为向量，对照导数与微分的联系**![[公式]](assets/1620480789-3608fd616421368ebb3550e4675b7533.svg)**，即能得到导数。**

  

再谈一谈复合：假设已求得![[公式]](assets/1620480789-16f65a6774c5a7b114d44e6e6cd73d51.svg)，而Y是X的函数，如何求![[公式]](assets/1620480789-9ef0d27880fa6426eef7cd30602db55a.svg)呢？从导数与微分的联系入手，![[公式]](assets/1620480789-94c4cb4afab772e901e159426547135f.svg)，可以推出链式法则![[公式]](assets/1620480789-9367963a63e5d27679a6c4e587227a9a.svg)。

和标量对矩阵的导数相比，矩阵对矩阵的导数形式更加复杂，从不同角度出发常会得到形式不同的结果。有一些Kronecker积和交换矩阵相关的恒等式，可用来做等价变形：

1.  ![[公式]](assets/1620480789-8913609e050ae38dac6ffa5129b4c062.svg)。
2.  ![[公式]](assets/1620480789-c71c8af6d60c556380c41cd041e1160b.svg)。
3.  ![[公式]](assets/1620480789-302b8ee859ae6359ccdb9f3722717b88.svg)。可以对![[公式]](assets/1620480789-5eaffa003d0eff07a55c614d01f07247.svg)求导来证明，一方面，直接求导得到![[公式]](assets/1620480789-bf0a524c8bebd965f371c16840df3ff7.svg)；另一方面，引入![[公式]](assets/1620480789-3ef3e7c6818e454a70ce875ddc9d5044.svg)，有![[公式]](assets/1620480789-5e37cfbf5b935f2f6177f1643f512b40.svg)，用链式法则得到![[公式]](assets/1620480789-5eaa5dbb40d44b74983a206a2face0e2.svg)。
4.  ![[公式]](assets/1620480789-0be25177e644dc2944c3c0b4d16cbc9b.svg)。
5.  ![[公式]](assets/1620480789-5acbd8dd8d6f1e02fbaa7d6e8ccd7da1.svg)，A是m×n矩阵，B是p×q矩阵。可以对![[公式]](assets/1620480789-d08c929e52c58eff4b47f99ac463ecb0.svg)做向量化来证明，一方面，![[公式]](assets/1620480789-398a8aa73c949c3bb8c485d1d4a5a963.svg)；另一方面，![[公式]](assets/1620480789-bac0af89bbc4fe9b5363f6064c48eb60.svg)。

  

接下来演示一些算例。

例1：![[公式]](assets/1620480789-a7504a086e679f97193f59f7d1dfd229.svg)，X是m×n矩阵，求![[公式]](assets/1620480789-9ef0d27880fa6426eef7cd30602db55a.svg)。

解：先求微分：![[公式]](assets/1620480789-9ee203b5b3059edc89a2014405a2f43b.svg)，再做向量化，使用矩阵乘法的技巧，注意在dX右侧添加单位阵：![[公式]](assets/1620480789-faf298b4fda5a793008cb3058e26ab95.svg)，对照导数与微分的联系得到![[公式]](assets/1620480789-3d3a08aa6574684252808b0048d4301c.svg)。

特例：如果X退化为向量，即![[公式]](assets/1620480789-15a6f14eae28886326d3148ebd77a4a3.svg)，则根据向量的导数与微分的关系![[公式]](assets/1620480789-7af9e57198d68cc131fcc6770296b49d.svg)，得到![[公式]](assets/1620480789-c18b49d9d862b2eec5847c4b2a0cd3a6.svg)。

  

例2：![[公式]](assets/1620480789-6efc1e8bd9fa732a7c0dfe17fba0bf31.svg)，X是n×n矩阵，求![[公式]](assets/1620480789-6b9f239705ee7da1a6ce8799041cfd02.svg)和![[公式]](assets/1620480789-182be573242203c55a34b6a1ce1deed9.svg)。

解：使用上篇中的技术可求得![[公式]](assets/1620480789-755812ec3208a039a7c912043ec2ca39.svg)。为求![[公式]](assets/1620480789-182be573242203c55a34b6a1ce1deed9.svg)，先求微分：![[公式]](assets/1620480789-89942000299433f197292acb2bd7be8c.svg)，再做向量化，使用转置和矩阵乘法的技巧![[公式]](assets/1620480789-f3a91768643cd7447dc1a60c3acc68f9.svg)，对照导数与微分的联系，得到![[公式]](assets/1620480789-7cb33801f8ce84d99c0dc8b836bc5463.svg)，注意它是对称矩阵。在![[公式]](assets/1620480789-6ce37be68c2df90fbb8ad8fe13a3f033.svg)是对称矩阵时，可简化为![[公式]](assets/1620480789-0335afb4c46b8ae26c9ea26019046c46.svg)。

  

例3：![[公式]](assets/1620480789-93e4a0c39645801a4a43f6a9d782b81e.svg)，A是l×m矩阵，X是m×n矩阵，B是n×p矩阵，exp为逐元素函数，求![[公式]](assets/1620480789-9ef0d27880fa6426eef7cd30602db55a.svg)。

解：先求微分：![[公式]](assets/1620480789-50d9087ada9025709bb9f1d1675750dc.svg)，再做向量化，使用矩阵乘法的技巧：![[公式]](assets/1620480789-b7541c35382eb57987d4e8f71234fc67.svg)，再用逐元素乘法的技巧：![[公式]](assets/1620480789-a5bcec466a94ce44c8f718bbca6a9602.svg)，再用矩阵乘法的技巧：![[公式]](assets/1620480789-1dff2ed4b4cf35658c0952bf52ad2d99.svg)，对照导数与微分的联系得到![[公式]](assets/1620480789-08b4aadf1f68c7463ffe790b99241653.svg)。

  

例4【一元logistic回归】：![[公式]](assets/1620480789-7d4b0611904c5b66b412db988db927a8.svg)，求![[公式]](assets/1620480789-8b0c797395729eced55a336b5e56479f.svg)和![[公式]](assets/1620480789-230e0ab6fe48a420f45848ea19c51a05.svg)。其中![[公式]](assets/1620480789-56151f71c4866c0e204ce3d096379823.svg)是取值0或1的标量，![[公式]](assets/1620480789-4e3b6089bf3203eba0bf246c5bfb5613.svg)是![[公式]](assets/1620480789-4b92dee5c11cc1784e9d2822857f1f4d.svg)列向量。

解：使用上篇中的技术可求得![[公式]](assets/1620480789-59f63d654af23e76e85b558d37d4524c.svg)，其中![[公式]](assets/1620480789-08b2456b2413a7f47a51101f45755a6c.svg) 为sigmoid函数。为求![[公式]](assets/1620480789-230e0ab6fe48a420f45848ea19c51a05.svg)，先求微分：![[公式]](assets/1620480789-672131a7f326a04efcf2812af26ed905.svg)，其中![[公式]](assets/1620480789-a5eb13ea5f65dae450ab90a019fa7bd1.svg)为sigmoid函数的导数，对照导数与微分的联系，得到![[公式]](assets/1620480789-fc3e051e9742d602baf2a27e4ed430b7.svg)。

推广：样本![[公式]](assets/1620480789-57f020cea067d2735fd2200328f73e74.svg)，![[公式]](assets/1620480789-e57b95e1cbdb6b2214c3a22142bcf104.svg)，求![[公式]](assets/1620480789-ad3195b5a534f6722079e736df0720ed.svg)和![[公式]](assets/1620480789-6a744b0a68226745fface6c08b04d291.svg)。有两种方法，解1：先对每个样本求导，然后相加；解2：定义矩阵![[公式]](assets/1620480789-07bdfbdd7991e270aa56b5270da234ab.svg)，向量![[公式]](assets/1620480789-f361a01d454ce5c4822403e1fd98e744.svg)，将![[公式]](assets/1620480789-f32f9aac32d40c08bf41372d319a306a.svg)写成矩阵形式![[公式]](assets/1620480789-d41d1dd8355bcfe1617c90c01d270e5f.svg)，进而可以使用上篇中的技术求得![[公式]](assets/1620480789-6a407490115882d8b0606e7a2833490a.svg)。为求![[公式]](assets/1620480789-230e0ab6fe48a420f45848ea19c51a05.svg)，先求微分，再用逐元素乘法的技巧：![[公式]](assets/1620480789-44f5354c7caec24ba5b783fb3ca33e2f.svg)，对照导数与微分的联系，得到![[公式]](assets/1620480789-09b193e548db465820a77ca6b5f88430.svg)。

  

例5【多元logistic回归】：![[公式]](assets/1620480789-02899af5d19bcd0c59e4f031cdeb1491.svg)，求![[公式]](assets/1620480789-c07941954fec2f77045d57302e27e47a.svg)和![[公式]](assets/1620480789-85641af5478d0c85cb76e45d2d5b3bcb.svg)。其中其中![[公式]](assets/1620480789-95f3155226c64dbe93966df4e18d3692.svg)是除一个元素为1外其它元素为0的![[公式]](assets/1620480789-e0f8668264115ddd23b342e9ecf00029.svg)列向量，![[公式]](assets/1620480789-2a437219c241ce5bc116bd50c17713d3.svg)是![[公式]](assets/1620480789-efded31b5fda68c35f6e2c4d41408a99.svg)矩阵，![[公式]](assets/1620480789-878735fee9916dce1437274caeb8a5c1.svg)是![[公式]](assets/1620480789-4b92dee5c11cc1784e9d2822857f1f4d.svg)列向量，![[公式]](assets/1620480789-f32f9aac32d40c08bf41372d319a306a.svg)是标量。

解：上篇中已求得![[公式]](assets/1620480789-0cdfff4200ee4cd3d3cdcc50dea71106.svg)。为求![[公式]](assets/1620480789-f54e7b7b8c4db9eeb759909da6c1c674.svg)，先求微分：定义![[公式]](assets/1620480789-ff18e0ade570b748e1ad1c12bc601fa1.svg)，![[公式]](assets/1620480789-56d960aff5a7252502bb97e6690e7a77.svg)![[公式]](assets/1620480789-c33c0e4d709ee6c8795bc47c32b5a2ae.svg)，注意这里化简去掉逐元素乘法，第一项中![[公式]](assets/1620480789-ab487d651c79dba2709a585aae27b128.svg)，第二项中![[公式]](assets/1620480789-37b3f2f627503f8adaa57fbba4c40d58.svg)。定义矩阵![[公式]](assets/1620480789-c977e6576c8595505353afed132c7712.svg)，![[公式]](assets/1620480789-78591341d7562facce69d0e64df7e9b2.svg)，做向量化并使用矩阵乘法的技巧，得到![[公式]](assets/1620480789-2d0ed008ceb2010e8905cdbab869ec32.svg)。

  

最后做个总结。我们发展了从**整体**出发的矩阵求导的技术，**导数与微分的联系是计算的枢纽**，标量对矩阵的导数与微分的联系是![[公式]](assets/1620480789-d1586577a2e20419875b0b9d6a0a3f41.svg)，先对f求微分，再使用迹技巧可求得导数，特别地，标量对向量的导数与微分的联系是![[公式]](assets/1620480789-fb1277df862b2326c19b2bf45dfc0896.svg)；矩阵对矩阵的导数与微分的联系是![[公式]](assets/1620480789-96628d9b8b54f96e8ecfa9ae8e0ee473.svg)，先对F求微分，再使用向量化的技巧可求得导数，特别地，向量对向量的导数与微分的联系是![[公式]](assets/1620480789-1de15beb18a7787f6907b132cfdf15d0.svg)。

  

  

参考资料：

1.  张贤达. _矩阵分析与应用_. 清华大学出版社有限公司, 2004.
2.  Fackler, Paul L. "Notes on matrix calculus." _North Carolina State University_(2005).
3.  Petersen, Kaare Brandt, and Michael Syskind Pedersen. "The matrix cookbook." _Technical University of Denmark_ 7 (2008): 15.
4.  HU, Pili. "Matrix Calculus: Derivation and Simple Application." (2012).
5.  Magnus, Jan R., and Heinz Neudecker. "Matrix Differential Calculus with Applications in Statistics and Econometrics." Wiley, 2019.